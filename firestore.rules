// rules_version = '2';
// service cloud.firestore {
//   match /databases/{database}/documents {

//     // Helper functions
//     function isAuthenticated() {
//       return request.auth != null;
//     }

//     function isOwner(userId) {
//       return isAuthenticated() && request.auth.uid == userId;
//     }

//     // ==================== USERS ====================
//     match /users/{userId} {
//       // Any authenticated user can read any user profile
//       // (needed for inviting to games by email)
//       allow read: if isAuthenticated();

//       // Users can only create/update their own profile
//       allow create: if isOwner(userId);
//       allow update: if isOwner(userId);
//       allow delete: if false; // Users can't delete themselves via Firestore
//     }

//     // ==================== GAMES ====================
//     match /games/{gameId} {
//       // Games can be read by GM or players (using resource.data directly)
//       allow get, list: if isAuthenticated() && (
//         resource.data.gmId == request.auth.uid ||
//         request.auth.uid in resource.data.playerIds
//       );

//       // Games can be created by any authenticated user
//       allow create: if isAuthenticated() &&
//                        request.resource.data.gmId == request.auth.uid;

//       // Only GM can update/delete the game
//       allow update, delete: if isAuthenticated() &&
//                                resource.data.gmId == request.auth.uid;

//       // ==================== CHARACTERS ====================
//       match /characters/{characterId} {
//         function getGameData() {
//           return get(/databases/$(database)/documents/games/$(gameId)).data;
//         }

//         function isGM() {
//           return isAuthenticated() && getGameData().gmId == request.auth.uid;
//         }

//         function isCharacterOwner() {
//           return isAuthenticated() &&
//                  resource.data.ownerId == request.auth.uid;
//         }

//         function canCreateCharacter() {
//           return isAuthenticated() &&
//                  request.resource.data.ownerId == request.auth.uid;
//         }

//         // GM sees all characters, players see only their own
//         allow read: if isGM() || isCharacterOwner();

//         // Players can create characters if they own them
//         allow create: if canCreateCharacter();

//         // Players can update/delete only their own characters
//         allow update, delete: if isCharacterOwner();
//       }

//       // ==================== KNOWLEDGE BASE ====================
//       match /knowledge/{type}/{itemId} {
//         function getGameData() {
//           return get(/databases/$(database)/documents/games/$(gameId)).data;
//         }

//         function isGM() {
//           return isAuthenticated() && getGameData().gmId == request.auth.uid;
//         }

//         function isPlayer() {
//           return isAuthenticated() && request.auth.uid in getGameData().playerIds;
//         }

//         // All game members can read knowledge base
//         // GM-only items are filtered on the client side
//         allow read: if isGM() || isPlayer();

//         // All game members can create/update knowledge base items
//         allow create, update: if isGM() || isPlayer();

//         // Only GM or creator can delete
//         allow delete: if isGM() ||
//                          (isAuthenticated() && resource.data.createdBy == request.auth.uid);
//       }

//       // ==================== GAME ITEMS ====================
//       match /gameItems/{itemId} {
//         function getGameData() {
//           return get(/databases/$(database)/documents/games/$(gameId)).data;
//         }

//         function isGM() {
//           return isAuthenticated() && getGameData().gmId == request.auth.uid;
//         }

//         function isPlayer() {
//           return isAuthenticated() && request.auth.uid in getGameData().playerIds;
//         }

//         // All game members can read game items
//         allow read: if isGM() || isPlayer();

//         // All game members can create/update game items
//         allow create, update: if isGM() || isPlayer();

//         // Only GM or creator can delete
//         allow delete: if isGM() ||
//                          (isAuthenticated() && resource.data.createdBy == request.auth.uid);
//       }
//     }
//   }
// }

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ==================== USERS ====================
    match /users/{userId} {
      // Any authenticated user can read any user profile
      // (needed for inviting to games by email)
      allow read: if isAuthenticated();

      // Users can only create/update their own profile
      allow create, update: if isAuthenticated() && isOwner(userId);

       // Users can't delete themselves via Firestore
      allow delete: if false;
    }

    // ==================== GAMES ====================
    match /games/{gameId} {
      function getGameData() {
        return get(/databases/$(database)/documents/games/$(gameId)).data;
      }

      function isGM() {
        return getGameData().gmId == request.auth.uid;
      }

      function isPlayer() {
        let data = getGameData();
        return request.auth.uid in data.playerIds || request.auth.uid == data.gmId;
      }

      // Games can be read by GM or players (using resource.data directly)
      allow read: if isAuthenticated() && (request.auth.uid in resource.data.playerIds || request.auth.uid == resource.data.gmId);

      // Games can be created by any authenticated user
      allow create: if isAuthenticated() && request.resource.data.gmId == request.auth.uid;

      // Only GM can update/delete the game
      allow update, delete: if isAuthenticated() && resource.data.gmId == request.auth.uid;

      // ==================== CHARACTERS ====================
      // Публичные данные персонажей - все участники игры читают
      match /characters/{characterId} {
        // Все участники игры могут читать публичные данные
        allow read: if isAuthenticated() && isPlayer();

        // Создавать может только владелец
        allow create: if isAuthenticated() && isOwner(request.resource.data.ownerId);

        // Редактировать/удалять может владелец или GM
        allow update, delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isGM());

        // ==================== PRIVATE CHARACTER DATA ====================
        // Приватные данные листа персонажа - только owner или GM
        match /private/{docId} {
          allow read, write: if isAuthenticated() && (
            isOwner(get(/databases/$(database)/documents/games/$(gameId)/characters/$(characterId)).data.ownerId) ||
            isGM()
          );
        }
      }

      // ==================== KNOWLEDGE BASE ====================
      match /knowledge/{type}/{itemId} {
        // All game members can read knowledge base
        allow read: if isAuthenticated() && isPlayer();

        // All game members can create/update knowledge base items
        allow create, update: if isAuthenticated() && isPlayer();

        // Only GM or creator can delete
        allow delete: if isAuthenticated() && (
          isGM() || resource.data.createdBy == request.auth.uid
        );
      }

      // ==================== GAME ITEMS ====================
      match /gameItems/{itemId} {
        // All game members can read game items
        allow read: if isAuthenticated() && isPlayer();

        // All game members can create/update game items
        allow create, update: if isAuthenticated() && isPlayer();

        // Only GM or creator can delete
        allow delete: if isAuthenticated() && (
          isGM() || resource.data.createdBy == request.auth.uid
        );
      }
    }
  }
}
